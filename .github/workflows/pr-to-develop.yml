name: Build and Create PR

on:
  push:
    branches:
      - 'feature/*'
      - 'hotfix/*'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Code checkout
        uses: actions/checkout@v4

      - name: Configure .NET 8
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'
          dotnet-quality: 'ga'
      
      - name: Install .NET 8 Runtime
        run: |
          sudo apt-get update
          sudo apt-get install -y dotnet-runtime-8.0 aspnetcore-runtime-8.0 dotnet-sdk-8.0
      
      - name: Allowing sh to execute
        run: chmod +x publish-native-aot.sh

      - name: Publish
        run: sh publish-native-aot.sh

  open-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Set GH Variable
        run: GH_TOKEN=${{ secrets.GITHUB_TOKEN }}

      - name: Validate if pull request exists
        run: |
          PR_EXIST=$(gh pr list --base develop --head ${{ github.ref_name }} --state open --json number --jq '.[0].number')
          echo "PR Exists: $PR_EXIST"
          if [ -n "$PR_EXIST" ]; then
            exit 0 
          fi

      - name: Criar Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Automatic merge from branch ${{ github.ref_name }} to develop"
          branch: ${{ github.ref_name }}
          base: develop
          title: "Automatic merge from ${{ github.ref_name }} to develop"
          body: "This Pull Request was generated automatically after a well succeeded build."
          delete-branch: false
